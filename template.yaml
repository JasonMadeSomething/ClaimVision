AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Parameters:
  Env:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - prod
    Description: Environment name
  S3BucketNameSSMPath:
    Type: String
    Default: /terraform/s3/bucket_name
    Description: SSM Parameter Store path for S3 bucket name
  CognitoUserPoolId:
    Type: String
    Description: The Cognito User Pool ID from the external stack
  RDSEndpointSSMPath:
    Type: String
    Default: /terraform/database/host
    Description: SSM Parameter Store path for RDS endpoint
  DBUsernameSSMPath:
    Type: String
    Default: /terraform/database/username
    Description: SSM Parameter Store path for database username
  DBPasswordSSMPath:
    Type: String
    Default: /terraform/database/password
    Description: SSM Parameter Store path for database password
  DBUsername:
    Type: String
    Description: Database username
  DBPassword:
    Type: String
    Description: Database password
  DBEndpoint:
    Type: String
    Description: Database endpoint
  FileUploadQueueURL:
    Type: String
    Description: URL of the file upload SQS queue
  FileUploadQueueARN:
    Type: String
    Description: ARN of the file upload SQS queue
  FileUploadQueueName:
    Type: String
    Description: Name of the file upload SQS queue
  FileAnalysisQueueURL:
    Type: String
    Description: URL of the file analysis SQS queue
  FileAnalysisQueueARN:
    Type: String
    Description: ARN of the file analysis SQS queue
  FileAnalysisQueueName:
    Type: String
    Description: Name of the file analysis SQS queue

Conditions:
  IsDev: !Equals
    - !Ref Env
    - dev

Mappings:
  CognitoExports:
    dev:
      UserPoolId: CognitoUserPoolId-dev
    prod:
      UserPoolId: CognitoUserPoolId-prod

Globals:
  Function:
    Timeout: 10
    MemorySize: 128
    Runtime: python3.12
    Environment:
      Variables:
        DB_USERNAME: !Ref DBUsername
        DB_PASSWORD: !Ref DBPassword
        DB_HOST: !Ref DBEndpoint
        DB_NAME: "claimvision"

Resources:
  # IAM Role for Lambda functions
  LambdaExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SSMParameterAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                Resource: 
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${DBUsernameSSMPath}'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${DBPasswordSSMPath}'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${RDSEndpointSSMPath}'
                  - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter${S3BucketNameSSMPath}'
        - PolicyName: DBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: "*"

  # IAM Role for Process File Lambda
  ProcessFileLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !Ref FileUploadQueueARN
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                Resource:
                  - !Ref FileAnalysisQueueARN
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                  - s3:PutObject
                  - s3:ListBucket
                Resource:
                  - !Sub arn:aws:s3:::claimvision-files-${AWS::AccountId}-${Env}
                  - !Sub arn:aws:s3:::claimvision-files-${AWS::AccountId}-${Env}/*
        - PolicyName: DBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: "*"

  # IAM Role for Analyze File Lambda
  AnalyzeFileLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: SQSAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:ChangeMessageVisibility
                Resource:
                  - !Ref FileAnalysisQueueARN
        - PolicyName: S3Access
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - s3:GetObject
                Resource:
                  - !Sub arn:aws:s3:::claimvision-files-${AWS::AccountId}-${Env}
                  - !Sub arn:aws:s3:::claimvision-files-${AWS::AccountId}-${Env}/*
        - PolicyName: DBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rds-db:connect
                Resource: "*"
        - PolicyName: RekognitionAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - rekognition:DetectLabels
                  - rekognition:DetectText
                Resource: "*"

  S3BucketName:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub "/claimvision/${Env}/s3-bucket-name"
      Type: String
      Value: !Sub "{{resolve:ssm:${S3BucketNameSSMPath}}}"
      Description: "S3 bucket name for ClaimVision"

  ###API###
  # API Gateway
  ClaimVisionAPI:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub ClaimVisionAPI-${Env}
      StageName: dev
      Cors:
        AllowMethods: '''OPTIONS,POST,GET'''
        AllowHeaders: '''Content-Type,Authorization'''
        AllowOrigin: '''*'''
      Auth:
        Authorizers:
          CognitoAuthorizer:
            UserPoolId: !Ref CognitoUserPoolId
            UserPoolArn: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
            IdentitySource: method.request.header.Authorization

  ###Lambdas###
  PostConfirmationLambda:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub ClaimVisionPostConfirmation-${Env}
      Runtime: python3.12
      Handler: auth.post_confirmation.lambda_handler
      CodeUri: src/
      Timeout: 10
      MemorySize: 128
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          USER_POOL_ID: !Ref CognitoUserPoolId
    Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
          Effect: Allow
          Action:
            - cognito-idp:AdminUpdateUserAttributes
          Resource: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}

  ##Auth##
  # Login Function
  LoginFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: auth.login.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_CLIENT_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolClientId-dev
            - !ImportValue CognitoUserPoolClientId-prod
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        LoginAPI:
          Type: Api
          Properties:
            Path: /auth/login
            Method: POST
            RestApiId: !Ref ClaimVisionAPI

  # Register Function
  RegisterFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: auth.register.lambda_handler
      Runtime: python3.12
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_CLIENT_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolClientId-dev
            - !ImportValue CognitoUserPoolClientId-prod
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        RegisterAPI:
          Type: Api
          Properties:
            Path: /auth/register
            Method: POST
            RestApiId: !Ref ClaimVisionAPI

  # Confirm Email
  ConfirmFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: auth.confirm.lambda_handler
      Runtime: python3.12
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_CLIENT_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolClientId-dev
            - !ImportValue CognitoUserPoolClientId-prod
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        ConfirmAPI:
          Type: Api
          Properties:
            Path: /auth/confirm
            Method: POST
            RestApiId: !Ref ClaimVisionAPI

  # Resend Email Verification
  ResendConfirmationFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: auth.resend_confirmation.lambda_handler
      Runtime: python3.12
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_CLIENT_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolClientId-dev
            - !ImportValue CognitoUserPoolClientId-prod
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'
      Events:
        ResendConfirmationAPI:
          Type: Api
          Properties:
            Path: /auth/resend-confirmation
            Method: POST
            RestApiId: !Ref ClaimVisionAPI

  # Dev bypass email verification
  PreSignUpFunction:
    Type: AWS::Serverless::Function
    Condition: IsDev
    Properties:
      CodeUri: src/
      Handler: auth.pre_signup.lambda_handler
      Runtime: python3.12
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
          AUTO_CONFIRM_USER: !If [IsDev, "true", "false"]
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'

  # Get Claims Function
  GetClaimsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: src/
      Handler: claims.get_claims.lambda_handler
      Runtime: python3.12
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetClaimsAPI:
          Type: Api
          Properties:
            Path: /claims
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer
  # Create Claim Function
  CreateClaimFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: claims.create_claim.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        CreateClaimAPI:
          Type: Api
          Properties:
            Path: /claims
            Method: POST
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Claim Function
  GetClaimFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: claims.get_claim.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetClaimAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Update Claim Function
  UpdateClaimFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: claims.update_claim.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        UpdateClaimAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Delete Claim Function
  DeleteClaimFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: claims.delete_claim.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        DeleteClaimAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}
            Method: DELETE
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Create Item Function
  CreateItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: items.create_item.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        CreateItemAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/items
            Method: POST
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Items Function
  GetItemsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: items.get_items.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetItemsAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/items
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Item Function
  GetItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: items.get_item.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetItemAPI:
          Type: Api
          Properties:
            Path: /items/{item_id}
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Update Item Function
  UpdateItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: items.update_item.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        UpdateItemAPI:
          Type: Api
          Properties:
            Path: /items/{item_id}
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Delete Item Function
  DeleteItemFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: items.delete_item.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        DeleteItemAPI:
          Type: Api
          Properties:
            Path: /items/{item_id}
            Method: DELETE
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Create Label Function
  CreateLabelFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: labels.create_label.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        CreateLabelAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}/labels
            Method: POST
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Labels Function
  GetLabelsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: labels.get_labels.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetLabelsAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}/labels
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Delete Label Function
  DeleteLabelFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: labels.delete_label.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        DeleteLabelAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}/labels/{label_id}
            Method: DELETE
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Remove Label Function
  RemoveLabelFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: labels.remove_label.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        RemoveLabelAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}/labels/{label_id}/remove
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Restore Label Function
  RestoreLabelFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: labels.restore_label.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        RestoreLabelAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}/labels/{label_id}/restore
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Room Functions
  # Create Room Function
  CreateRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rooms.create_room.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        CreateRoomAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/rooms
            Method: POST
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Rooms Function
  GetRoomsFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rooms.get_rooms.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetRoomsAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/rooms
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Room Function
  GetRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rooms.get_room.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetRoomAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/rooms/{room_id}
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Update Room Function
  UpdateRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rooms.update_room.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        UpdateRoomAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/rooms/{room_id}
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Delete Room Function
  DeleteRoomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: rooms.delete_room.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        DeleteRoomAPI:
          Type: Api
          Properties:
            Path: /claims/{claim_id}/rooms/{room_id}
            Method: DELETE
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  ##Admin##
  # Get Users Function
  GetUsersFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: admin.get_users.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:ListUsers # Allow listing users in Cognito
            Resource:
              - !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_ID: !If
            - IsDev
            - !ImportValue CognitoUserPoolId-dev
            - !ImportValue CognitoUserPoolId-prod
      Events:
        GetUsersAPI:
          Type: Api
          Properties:
            Path: /admin/users
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Update User Role Function
  UpdateUserRoleFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: admin.update_user_role.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'
        - Statement:
            Effect: Allow
            Action:
              - cognito-idp:AdminAddUserToGroup
              - cognito-idp:AdminRemoveUserFromGroup
            Resource: !Sub arn:aws:cognito-idp:${AWS::Region}:${AWS::AccountId}:userpool/${CognitoUserPoolId}
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          COGNITO_USER_POOL_ID: !Ref CognitoUserPoolId
      Events:
        UpdateUserRoleAPI:
          Type: Api
          Properties:
            Path: /admin/users/{username}/role
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Files Function (Paginated)
  GetFilesFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.get_files.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        GetFilesAPI:
          Type: Api
          Properties:
            Path: /files
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Get Single File Metadata Function
  GetFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.get_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Architectures:
        - x86_64
      Policies:
        - Statement:
            Effect: Allow
            Action:
              - ssm:GetParameter
            Resource:
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
              - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'
        - AWSLambdaBasicExecutionRole
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          S3_BUCKET_NAME: !Ref S3BucketName
      Events:
        GetFileAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}
            Method: GET
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Update File Metadata Function (PATCH)
  UpdateFileMetadataFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.update_file_metadata.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Events:
        UpdateFileMetadataAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}
            Method: PATCH
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Replace File Function (PUT)
  ReplaceFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.replace_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Architectures:
        - x86_64
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          S3_BUCKET_NAME: !Ref S3BucketName
      Events:
        ReplaceFileAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}
            Method: PUT
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

  # Delete File Function
  DeleteFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.delete_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Architectures:
        - x86_64
      Environment:
        Variables:
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
          S3_BUCKET_NAME: !Ref S3BucketName
      Events:
        DeleteFileAPI:
          Type: Api
          Properties:
            Path: /files/{file_id}
            Method: DELETE
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer

    Policies:
      - AWSLambdaBasicExecutionRole
      - Statement:
          Effect: Allow
          Action:
            - ssm:GetParameter
          Resource:
            - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${RDSEndpointSSMPath}'
            - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBUsernameSSMPath}'
            - !Sub 'arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${DBPasswordSSMPath}'

  UploadFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.upload_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt LambdaExecutionRole.Arn
      Architectures:
        - x86_64
      Events:
        UploadFileAPI:
          Type: Api
          Properties:
            Path: /files/upload
            Method: POST
            RestApiId: !Ref ClaimVisionAPI
            Auth:
              Authorizer: CognitoAuthorizer
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3BucketName
          SQS_UPLOAD_QUEUE_URL: !Ref FileUploadQueueURL
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"
      Policies:
        - S3CrudPolicy:
            BucketName: !Sub claimvision-files-${AWS::AccountId}-${Env}
        - SQSSendMessagePolicy:
            QueueName: !Ref FileUploadQueueName

  ProcessFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.process_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt ProcessFileLambdaRole.Arn
      Architectures:
        - x86_64
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !Ref FileUploadQueueARN
            BatchSize: 10
            MaximumBatchingWindowInSeconds: 30
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3BucketName
          SQS_ANALYSIS_QUEUE_URL: !Ref FileAnalysisQueueURL
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"

  AnalyzeFileFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: files.analyze_file.lambda_handler
      Runtime: python3.12
      CodeUri: src/
      Role: !GetAtt AnalyzeFileLambdaRole.Arn
      Architectures:
        - x86_64
      Events:
        SQSTrigger:
          Type: SQS
          Properties:
            Queue: !Ref FileAnalysisQueueARN
            BatchSize: 5
            MaximumBatchingWindowInSeconds: 60
      Environment:
        Variables:
          S3_BUCKET_NAME: !Ref S3BucketName
          MIN_CONFIDENCE: "70.0"
          DB_USERNAME: !Ref DBUsername
          DB_PASSWORD: !Ref DBPassword
          DB_HOST: !Ref DBEndpoint
          DB_NAME: "claimvision"

Outputs:
  #  Print API Gateway URL After Deployment
  ApiGatewayInvokeURL:
    Description: API Gateway Invoke URL
    Value: !Sub https://${ClaimVisionAPI}.execute-api.${AWS::Region}.amazonaws.com/dev
  PostConfirmationLambdaArn:
    Description: ARN of the Post Confirmation Lambda
    Value: !GetAtt PostConfirmationLambda.Arn
    Export:
      Name: !Sub ClaimVision-PostConfirmationLambdaArn-${Env}